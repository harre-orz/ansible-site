---
- name: gather variables for each operating system
  include_vars: "{{ item }}"
  with_first_found:
  - "_{{ ansible_hostname }}.yml"
  - "{{ ansible_architecture | lower }}/{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
  - "{{ ansible_architecture | lower }}/{{ ansible_distribution | lower }}.yml"
  - "{{ ansible_architecture | lower }}/{{ ansible_os_family | lower }}.yml"
  - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
  - "{{ ansible_distribution | lower }}.yml"
  - "{{ ansible_os_family | lower }}.yml"
  tags: [ always ]

- include: cyrus-sasl.yml
  when: postfix_sasl_password | length > 0

- name: install postfix
  become: yes
  package:
    name: postfix

- name: backup the original config file
  become: yes
  command: cp -af {{ item }} {{ item }}.orig
  args:
    creates: "{{ item }}.orig"
  with_items:
  - "/etc/postfix/main.cf"
  - "/etc/postfix/master.cf"

- name: put sasl_password
  become: yes
  copy:
    content: |
      {% for item in postfix_sasl_password %}
      {{ item.host }} {{ item.user }}:{{ item.password }}
      {% endfor %}
    dest: "{{ postfix_sasl_password_file }}"
    owner: root
    group: root
    mode: 0600
  when: postfix_sasl_password | length > 0
  notify:
  - postfix postmap sasl_password
  - postfix reload
  tags: [ reconfigure ]

- name: put main.cf
  become: yes
  template:
    src: main.cf.j2
    dest: /etc/postfix/main.cf
    owner: root
    group: root
    mode: 0644
  notify: postfix reload
  tags: [ reconfigure ]

- name: auto start
  become: yes
  service:
    name: postfix
    state: started
    enabled: yes

- name: get sha256 in main_cf file
  become: yes
  stat:
    path: /etc/postfix/main.cf
    checksum_algorithm: sha256
  register: _sshd_config_file_sha256
  tags: [ reconfigure ]

- name: put gossfile
  become: yes
  template:
    src: goss.yml.j2
    dest: "{{ goss_dir }}/postfix.yml"
    owner: root
    group: root
    mode: 0600
  when: goss_dir is defined
  tags: [ reconfigure ]
