---
- name: Debian固有の変数を取り込む
  include_vars: "os_{{ ansible_os_family }}.yml"
  when: ansible_os_family == "Debian"

- name: 設定ファイルをバックアップ
  shell: "cp -af {{ sshd_conf }} {{ sshd_conf }}.org"
  args:
    creates: "{{ sshd_conf }}.org"

- name: sshusersグループを作成
  group:
    name: sshusers

- name: "{{ ansible_ssh_user }}にsshusersグループを追加"
  user:
    name: "{{ ansible_ssh_user }}"
    groups: sshusers
    append: yes

- name: アドレスファミリーを設定
  lineinfile:
    path: "{{ sshd_conf }}"
    insertafter: "^#AddressFamily "
    regexp: "^AddressFamily "
    line: "AddressFamily {{ sshd_addrspec }}"
  when:
    - sshd_addrspec != "any"
  notify: sshd restart

- name: 公開IPアドレスを設定
  lineinfile:
    path: "{{ sshd_conf }}"
    insertafter: "^#ListenAddress "
    regexp: "^ListenAddress "
    line: "ListenAddress {{ sshd_address | ipaddr }}"
  when:
    - sshd_address != "0.0.0.0"
    - sshd_address != "::"
  notify: sshd restart

- name: 公開ポート番号を設定
  lineinfile:
    path: "{{ sshd_conf }}"
    insertafter: "^#Port "
    regexp: "^Port "
    line: "Port {{ sshd_port | int }}"
  when: sshd_port | int != 22
  notify: sshd restart

- name: 設定ファイルの変更項目を定義
  set_fact:
    sshd_config_params:
      - { name: AllowGroups, value: sshusers }
      - { name: PasswordAuthentication, value: "{{ sshd_ask_pass }}" }
      - { name: ChallengeResponseAuthentication, value: 'no' }
      - { name: PermitRootLogin, value: "{{ sshd_permit_root_login }}" }
      - { name: UsePAM, value: 'yes' }
      - { name: UseDNS, value: 'no' }

- name: 変更項目に従い設定変更
  lineinfile:
    path: "{{ sshd_conf }}"
    insertafter: "^#{{ item.name }} "
    regexp: "^{{ item.name }} "
    line: "{{ item.name }} {{ item.value }}"
    validate: "{{ sshd_executable }} -t -f %s"
  with_items: "{{ sshd_config_params }}"
  notify: sshd restart

- name: 自動起動
  service:
    name: "{{ sshd_service }}"
    state: started
    enabled: yes
  notify: sshd restart

- name: テストファイルを配置
  copy:
    content: |
      service:
        sshd:
          running: true
          enabled: true
      port:
      {% if sshd_addrspec != "inet6" %}
        tcp:{{ sshd_port | int }}:
          listening: true
          ip:
      {% if sshd_address == "::" %}
            - "0.0.0.0"
      {% else %}
            - "{{ sshd_address | ipv4 }}"
      {% endif %}
      {% endif %}
      {% if sshd_addrspec != "inet" %}
      tcp6:{{ sshd_port | int }}:
        listening: true
        ip:
      {% if sshd_address == "0.0.0.0" %}
          - "::"
      {% else %}
          - "{{ sshd_address | ipv6 }}"
      {% endif %}
      {% endif %}
      user:
        {{ ansible_ssh_user }}:
          exists: true
          groups:
            - "sshusers"
      group:
        sshusers:
          exists: true
      file:
        {{ sshd_conf }}:
          exists: true
          contains:
      {% for item in sshd_config_params %}
            - "/^{{ item.name }} {{ item.value }}$/"
      {% endfor %}
    dest: "{{ goss_workdir }}/sshd.yml"
